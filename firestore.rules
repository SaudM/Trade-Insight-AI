/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model.  Each user has complete control over their data,
 * which is isolated under their unique user ID within the `/users/{userId}` collection. This design ensures
 * data privacy and prevents unauthorized access between users.
 *
 * Data Structure:
 * All data is nested under `/users/{userId}`, creating a clear hierarchical structure:
 * - `/users/{userId}`: User profile information.
 * - `/users/{userId}/subscription/current`: Current subscription status for the user.
 * - `/users/{userId}/tradeLogs/{tradeLogId}`: Trade log entries for the user.
 * - `/users/{userId}/dailyAnalyses/{dailyAnalysisId}`: Daily analysis reports for the user.
 * - `/users/{userId}/weeklyReviews/{weeklyReviewId}`: Weekly review reports for the user.
 * - `/users/{userId}/weeklyReviews/{weeklyReviewId}/weeklyImprovementPlan`: Weekly improvement plans for the user.
 * - `/users/{userId}/monthlySummaries/{monthlySummaryId}`: Monthly summary reports for the user.
 *
 * Key Security Decisions:
 * - User data is strictly segregated based on the `userId` in the path.
 * - Listing of users is disallowed.
 * - All write operations are validated against the authenticated user's ID.
 *
 * Denormalization for Authorization:
 *  - The `userId` is embedded in each document to allow for direct ownership checks, avoiding costly `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces access control for user profiles. Only the owner can read and write their own profile.
     * @path /users/{userId}
     * @allow (create, update, delete, get, list) User with UID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' can create/modify their own user document.
     * @deny (create, update, delete, get, list) User with UID 'differentUserUID' cannot access user document with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return resource.data.userId == request.auth.uid;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

     /**
     * @description Enforces access control for the user's current subscription. Only the owner can read and write their own subscription data.
     * @path /users/{userId}/subscription/current
     * @allow (get, create, update, delete) User with UID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' can read/modify their subscription document.
     * @deny (get, create, update, delete) User with UID 'differentUserUID' cannot access subscription document under user ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/subscription/current {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner(userId) {
            return request.auth.uid == userId;
        }

        function isExistingOwner(userId) {
            return resource.data.userId == request.auth.uid;
        }

        allow get: if isSignedIn() && isOwner(userId);
        allow list: if false;
        allow create: if isSignedIn() && isOwner(userId);
        allow update: if isSignedIn() && isExistingOwner(userId);
        allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for trade log entries. Only the owner can read and write their own trade logs.
     * @path /users/{userId}/tradeLogs/{tradeLogId}
     * @allow (create, update, delete, get, list) User with UID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' can create/modify their own trade log entries.
     * @deny (create, update, delete, get, list) User with UID 'differentUserUID' cannot access trade log entries under user ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/tradeLogs/{tradeLogId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return resource.data.userId == request.auth.uid;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for daily analysis reports. Only the owner can read and write their own daily analysis reports.
     * @path /users/{userId}/dailyAnalyses/{dailyAnalysisId}
     * @allow (create, update, delete, get, list) User with UID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' can create/modify their own daily analysis reports.
     * @deny (create, update, delete, get, list) User with UID 'differentUserUID' cannot access daily analysis reports under user ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/dailyAnalyses/{dailyAnalysisId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return resource.data.userId == request.auth.uid;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for weekly review reports. Only the owner can read and write their own weekly review reports.
     * @path /users/{userId}/weeklyReviews/{weeklyReviewId}
     * @allow (create, update, delete, get, list) User with UID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' can create/modify their own weekly review reports.
     * @deny (create, update, delete, get, list) User with UID 'differentUserUID' cannot access weekly review reports under user ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/weeklyReviews/{weeklyReviewId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return resource.data.userId == request.auth.uid;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for weekly improvement plans. Only the owner can read and write their own weekly improvement plans.
     * @path /users/{userId}/weeklyReviews/{weeklyReviewId}/weeklyImprovementPlan
     * @allow (create, update, delete, get, list) User with UID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' can create/modify their own weekly improvement plans.
     * @deny (create, update, delete, get, list) User with UID 'differentUserUID' cannot access weekly improvement plans under user ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/weeklyReviews/{weeklyReviewId}/weeklyImprovementPlan {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return resource.data.userId == request.auth.uid;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for monthly summary reports. Only the owner can read and write their own monthly summary reports.
     * @path /users/{userId}/monthlySummaries/{monthlySummaryId}
     * @allow (create, update, delete, get, list) User with UID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' can create/modify their own monthly summary reports.
     * @deny (create, update, delete, get, list) User with UID 'differentUserUID' cannot access monthly summary reports under user ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/monthlySummaries/{monthlySummaryId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return resource.data.userId == request.auth.uid;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }
  }
}