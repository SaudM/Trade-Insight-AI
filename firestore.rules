/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Each user has full
 * control over their data stored under their unique user ID.
 *
 * Data Structure:
 * All data is nested under /users/{userId}, ensuring clear ownership.
 * Subscription status is available at /users/{userId}/subscription/current for easy access.
 *
 * Key Security Decisions:
 * - Users can only access their own data.
 * - Users cannot list other users' data.
 *
 * Denormalization for Authorization:
 * No denormalization is needed as path-based ownership using the Firebase auth UID is employed.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /users/{userId}
     * @allow (create) User with matching UID can create their own profile.
     * @deny (create) User attempts to create a profile with a mismatched UID.
     * @allow (get) User can retrieve their own profile.
     * @deny (get) User attempts to retrieve another user's profile.
     * @allow (update) User can update their own profile.
     * @deny (update) User attempts to update another user's profile.
     * @allow (delete) User can delete their own profile.
     * @deny (delete) User attempts to delete another user's profile.
     * @principle Enforces document ownership for writes and reads.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

     /**
      * @description Controls access to the user's current subscription information.
      * @path /users/{userId}/subscription/current
      * @allow (create) User with matching UID can create their subscription details.
      * @deny (create) User attempts to create subscription details with a mismatched UID.
      * @allow (get) User can retrieve their own subscription details.
      * @deny (get) User attempts to retrieve another user's subscription details.
      * @allow (update) User can update their own subscription details.
      * @deny (update) User attempts to update another user's subscription details.
      * @allow (delete) User can delete their own subscription details.
      * @deny (delete) User attempts to delete another user's subscription details.
      * @principle Enforces document ownership for subscription data.
      */
    match /users/{userId}/subscription/current {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow create: if isSignedIn() && isOwner(userId);
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to trade log entries for a given user.
     * @path /users/{userId}/tradeLogs/{tradeLogId}
     * @allow (create) User with matching UID can create trade log entries.
     * @deny (create) User attempts to create trade log entries with a mismatched UID.
     * @allow (get) User can retrieve their own trade log entries.
     * @deny (get) User attempts to retrieve another user's trade log entries.
     * @allow (update) User can update their own trade log entries.
     * @deny (update) User attempts to update another user's trade log entries.
     * @allow (delete) User can delete their own trade log entries.
     * @deny (delete) User attempts to delete another user's trade log entries.
     * @principle Enforces document ownership for trade log data.
     */
    match /users/{userId}/tradeLogs/{tradeLogId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to daily analysis reports for a given user.
     * @path /users/{userId}/dailyAnalyses/{dailyAnalysisId}
     * @allow (create) User with matching UID can create daily analysis reports.
     * @deny (create) User attempts to create daily analysis reports with a mismatched UID.
     * @allow (get) User can retrieve their own daily analysis reports.
     * @deny (get) User attempts to retrieve another user's daily analysis reports.
     * @allow (update) User can update their own daily analysis reports.
     * @deny (update) User attempts to update another user's daily analysis reports.
     * @allow (delete) User can delete their own daily analysis reports.
     * @deny (delete) User attempts to delete another user's daily analysis reports.
     * @principle Enforces document ownership for daily analysis data.
     */
    match /users/{userId}/dailyAnalyses/{dailyAnalysisId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to weekly review reports for a given user.
     * @path /users/{userId}/weeklyReviews/{weeklyReviewId}
     * @allow (create) User with matching UID can create weekly review reports.
     * @deny (create) User attempts to create weekly review reports with a mismatched UID.
     * @allow (get) User can retrieve their own weekly review reports.
     * @deny (get) User attempts to retrieve another user's weekly review reports.
     * @allow (update) User can update their own weekly review reports.
     * @deny (update) User attempts to update another user's weekly review reports.
     * @allow (delete) User can delete their own weekly review reports.
     * @deny (delete) User attempts to delete another user's weekly review reports.
     * @principle Enforces document ownership for weekly review data.
     */
    match /users/{userId}/weeklyReviews/{weeklyReviewId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to weekly improvement plans for a given user's weekly review.
     * @path /users/{userId}/weeklyReviews/{weeklyReviewId}/weeklyImprovementPlan
     * @allow (create) User with matching UID can create weekly improvement plans.
     * @deny (create) User attempts to create weekly improvement plans with a mismatched UID.
     * @allow (get) User can retrieve their own weekly improvement plans.
     * @deny (get) User attempts to retrieve another user's weekly improvement plans.
     * @allow (update) User can update their own weekly improvement plans.
     * @deny (update) User attempts to update another user's weekly improvement plans.
     * @allow (delete) User can delete their own weekly improvement plans.
     * @deny (delete) User attempts to delete another user's weekly improvement plans.
     * @principle Enforces document ownership for weekly improvement plan data.
     */
    match /users/{userId}/weeklyReviews/{weeklyReviewId}/weeklyImprovementPlan {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow create: if isSignedIn() && isOwner(userId);
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to monthly summary reports for a given user.
     * @path /users/{userId}/monthlySummaries/{monthlySummaryId}
     * @allow (create) User with matching UID can create monthly summary reports.
     * @deny (create) User attempts to create monthly summary reports with a mismatched UID.
     * @allow (get) User can retrieve their own monthly summary reports.
     * @deny (get) User attempts to retrieve another user's monthly summary reports.
     * @allow (update) User can update their own monthly summary reports.
     * @deny (update) User attempts to update another user's monthly summary reports.
     * @allow (delete) User can delete their own monthly summary reports.
     * @deny (delete) User attempts to delete another user's monthly summary reports.
     * @principle Enforces document ownership for monthly summary data.
     */
    match /users/{userId}/monthlySummaries/{monthlySummaryId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }
  }
}