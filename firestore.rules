/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for all data.
 *
 * Data Structure:
 * All data is nested under /users/{userId}, with subcollections for trade logs, daily analyses,
 * weekly reviews, and monthly summaries.  A singleton `subscription/current` document stores the user's current
 * subscription status.
 *
 * Key Security Decisions:
 * - Users can only access their own data.
 * - Data validation is minimized in this prototyping phase.  Only checks critical for authorization are performed.
 * - Listing of user subcollections is allowed only for the owner.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by the owner of the resource.
     * @param {string} userId The user ID to compare against the request's auth UID.
     * @return {bool} True if the request is made by the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    /**
     * @description Checks if the request is made by an existing owner of the resource.
     * @param {string} userId The user ID to compare against the request's auth UID.
     * @return {bool} True if the request is made by an existing owner, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the incoming data for User object is valid.  Only id field needs to match the `userId`
     * @return {bool} True if the data is valid, false otherwise.
     */
    function isValidUserCreateData(userId) {
      return request.resource.data.id == userId;
    }

   /**
     * @description Enforces that the ownership field (`id`) is immutable and matches the path.
     * @param {string} userId The user ID from the path.
     * @return {bool} True if the `id` field is immutable and correct.
     */
    function isValidUserUpdateData(userId) {
      return request.resource.data.id == resource.data.id && request.resource.data.id == userId;
    }

    /**
     * @description
     * Applies to the root user document.
     * Only the user can read, update, or delete their own document.
     * @path /users/{userId}
     * @allow (create) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' creates their own document. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' and request.resource.data.id == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (get) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' reads their own document. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (update) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' updates their own document. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (delete) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' deletes their own document. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @deny (create) - User with ID 'AttackerId' attempts to create a document with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (get) - User with ID 'AttackerId' attempts to read the document of user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (update) - User with ID 'AttackerId' attempts to update the document of user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (delete) - User with ID 'AttackerId' attempts to delete the document of user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow create: if isOwner(userId) && isValidUserCreateData(userId);
      allow get: if isOwner(userId);
      allow list: if false;
      allow update: if isExistingOwner(userId) && isValidUserUpdateData(userId);
      allow delete: if isExistingOwner(userId);
    }

     /**
     * @description
     * Applies to the singleton subscription document.
     * Only the user can read, create, update, or delete their own subscription.
     * @path /users/{userId}/subscription/current
     * @allow (create) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' creates their own subscription document. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (get) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' reads their own subscription document. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (update) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' updates their own subscription document. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (delete) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' deletes their own subscription document. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @deny (create) - User with ID 'AttackerId' attempts to create the subscription document of user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (get) - User with ID 'AttackerId' attempts to read the subscription document of user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (update) - User with ID 'AttackerId' attempts to update the subscription document of user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (delete) - User with ID 'AttackerId' attempts to delete the subscription document of user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/subscription/current {
      allow create: if isOwner(userId);
      allow get: if isOwner(userId);
      allow list: if false;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }


    /**
     * @description
     * Applies to trade logs for a specific user.
     * Only the user can read, create, update, or delete their own trade logs.
     * @path /users/{userId}/tradeLogs/{tradeLogId}
     * @allow (create) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' creates a trade log. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (get) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' reads their own trade log. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (update) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' updates their own trade log. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (delete) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' deletes their own trade log. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @deny (create) - User with ID 'AttackerId' attempts to create a trade log for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (get) - User with ID 'AttackerId' attempts to read a trade log for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (update) - User with ID 'AttackerId' attempts to update a trade log for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (delete) - User with ID 'AttackerId' attempts to delete a trade log for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/tradeLogs/{tradeLogId} {
      allow create: if isOwner(userId);
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description
     * Applies to daily analyses for a specific user.
     * Only the user can read, create, update, or delete their own daily analyses.
     * @path /users/{userId}/dailyAnalyses/{dailyAnalysisId}
     * @allow (create) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' creates a daily analysis. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (get) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' reads their own daily analysis. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (update) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' updates their own daily analysis. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (delete) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' deletes their own daily analysis. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @deny (create) - User with ID 'AttackerId' attempts to create a daily analysis for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (get) - User with ID 'AttackerId' attempts to read a daily analysis for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (update) - User with ID 'AttackerId' attempts to update a daily analysis for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (delete) - User with ID 'AttackerId' attempts to delete a daily analysis for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/dailyAnalyses/{dailyAnalysisId} {
      allow create: if isOwner(userId);
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description
     * Applies to weekly reviews for a specific user.
     * Only the user can read, create, update, or delete their own weekly reviews.
     * @path /users/{userId}/weeklyReviews/{weeklyReviewId}
     * @allow (create) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' creates a weekly review. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (get) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' reads their own weekly review. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (update) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' updates their own weekly review. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (delete) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' deletes their own weekly review. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @deny (create) - User with ID 'AttackerId' attempts to create a weekly review for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (get) - User with ID 'AttackerId' attempts to read a weekly review for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (update) - User with ID 'AttackerId' attempts to update a weekly review for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (delete) - User with ID 'AttackerId' attempts to delete a weekly review for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/weeklyReviews/{weeklyReviewId} {
      allow create: if isOwner(userId);
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description
     * Applies to weekly improvement plans for a specific user and weekly review.
     * Only the user can read, create, update, or delete their own weekly improvement plan.
     * @path /users/{userId}/weeklyReviews/{weeklyReviewId}/weeklyImprovementPlan
     * @allow (create) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' creates a weekly improvement plan. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (get) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' reads their own weekly improvement plan. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (update) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' updates their own weekly improvement plan. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (delete) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' deletes their own weekly improvement plan. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @deny (create) - User with ID 'AttackerId' attempts to create a weekly improvement plan for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (get) - User with ID 'AttackerId' attempts to read a weekly improvement plan for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (update) - User with ID 'AttackerId' attempts to update a weekly improvement plan for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (delete) - User with ID 'AttackerId' attempts to delete a weekly improvement plan for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/weeklyReviews/{weeklyReviewId}/weeklyImprovementPlan {
      allow create: if isOwner(userId);
      allow get: if isOwner(userId);
      allow list: if false;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description
     * Applies to monthly summaries for a specific user.
     * Only the user can read, create, update, or delete their own monthly summaries.
     * @path /users/{userId}/monthlySummaries/{monthlySummaryId}
     * @allow (create) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' creates a monthly summary. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (get) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' reads their own monthly summary. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (update) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' updates their own monthly summary. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @allow (delete) - User with ID 'dKA5w1X5uMZUGAMF5GHrYtA6QB82' deletes their own monthly summary. request.auth.uid == 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'.
     * @deny (create) - User with ID 'AttackerId' attempts to create a monthly summary for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (get) - User with ID 'AttackerId' attempts to read a monthly summary for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (update) - User with ID 'AttackerId' attempts to update a monthly summary for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @deny (delete) - User with ID 'AttackerId' attempts to delete a monthly summary for user 'dKA5w1X5uMZUGAMF5GHrYtA6QB82'. Fails because request.auth.uid != userId.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/monthlySummaries/{monthlySummaryId} {
      allow create: if isOwner(userId);
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}